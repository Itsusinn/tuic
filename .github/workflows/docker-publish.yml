name: Build and Publish Docker Image

on:
  workflow_call:
    inputs:
      docker-file:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: '.github/Dockerfile'
      image-name:
        description: 'Base name of the Docker image'
        required: false
        type: string
        default: 'tuic-server'
      platforms:
        description: 'Platforms to build for'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      binary-dir:
        description: 'Directory containing the binaries'
        required: false
        type: string
        default: './docker-bins'
      server-binary-amd64:
        description: 'Path to amd64 server binary'
        required: false
        type: string
        default: 'tuic-server-x86_64-linux-musl'
      server-binary-arm64:
        description: 'Path to arm64 server binary'
        required: false
        type: string
        default: 'tuic-server-aarch64-linux-musl'
    secrets:
      dockerhub-username:
        description: 'Docker Hub username'
        required: false
      dockerhub-token:
        description: 'Docker Hub token'
        required: false

jobs:
  docker:
    name: Docker
    runs-on: ubuntu-latest
    steps:
      #--------------------------------------------------
      # Setup Steps
      #--------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug

      #--------------------------------------------------
      # Binary Preparation
      #--------------------------------------------------
      - name: Download compiled binaries
        uses: actions/download-artifact@v7
        with:
          pattern: "*-binaries"
          path: ./packages
          merge-multiple: true

      - name: Prepare binaries for multi-arch Docker image
        run: |
          mkdir -p ${{ inputs.binary-dir }}
          cp ./packages/${{ inputs.server-binary-amd64 }} ${{ inputs.binary-dir }}/tuic-server-amd64
          cp ./packages/${{ inputs.server-binary-arm64 }} ${{ inputs.binary-dir }}/tuic-server-arm64
          chmod +x ${{ inputs.binary-dir }}/tuic-server-*

      #--------------------------------------------------
      # Docker Registry Authentication
      #--------------------------------------------------
      - name: Check Docker Hub credentials
        id: check_dockerhub
        run: |
          if [ -n "${{ secrets.dockerhub-username }}" ]; then
            echo "PUBLISH_DOCKERHUB=true" >> $GITHUB_OUTPUT
          else
            echo "PUBLISH_DOCKERHUB=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: steps.check_dockerhub.outputs.PUBLISH_DOCKERHUB == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.dockerhub-username }}
          password: ${{ secrets.dockerhub-token }}

      #--------------------------------------------------
      # Docker Tag Management
      #--------------------------------------------------
      - name: Configure Docker image tags
        id: docker_tags
        run: |
          if [[ $GITHUB_REF == refs/heads/main ]] || [[ $GITHUB_REF == refs/pull/*/merge ]]; then
            # Development build
            echo "GHCR_VERSION_TAG=ghcr.io/${GITHUB_REPOSITORY_OWNER@L}/${{ inputs.image-name }}:0.0.0" >> $GITHUB_OUTPUT
            echo "GHCR_LATEST_TAG=ghcr.io/${GITHUB_REPOSITORY_OWNER@L}/${{ inputs.image-name }}:latest" >> $GITHUB_OUTPUT
            if [ "${{ steps.check_dockerhub.outputs.PUBLISH_DOCKERHUB }}" == "true" ]; then
              DOCKERHUB_REPO="${{ secrets.dockerhub-username }}/${{ inputs.image-name }}"
              echo "DOCKERHUB_VERSION_TAG=${DOCKERHUB_REPO}:0.0.0" >> $GITHUB_OUTPUT
              echo "DOCKERHUB_LATEST_TAG=${DOCKERHUB_REPO}:latest" >> $GITHUB_OUTPUT
            fi
          else
            # Release build
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "GHCR_VERSION_TAG=ghcr.io/${GITHUB_REPOSITORY_OWNER@L}/${{ inputs.image-name }}:${VERSION}" >> $GITHUB_OUTPUT
            echo "GHCR_LATEST_TAG=ghcr.io/${GITHUB_REPOSITORY_OWNER@L}/${{ inputs.image-name }}:latest" >> $GITHUB_OUTPUT
            if [ "${{ steps.check_dockerhub.outputs.PUBLISH_DOCKERHUB }}" == "true" ]; then
              DOCKERHUB_REPO="${{ secrets.dockerhub-username }}/${{ inputs.image-name }}"
              echo "DOCKERHUB_VERSION_TAG=${DOCKERHUB_REPO}:${VERSION}" >> $GITHUB_OUTPUT
              echo "DOCKERHUB_LATEST_TAG=${DOCKERHUB_REPO}:latest" >> $GITHUB_OUTPUT
            fi
          fi

      #--------------------------------------------------
      # Docker Build & Push
      #--------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.docker-file }}
          platforms: ${{ inputs.platforms }}
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}
          tags: |
            ${{ steps.docker_tags.outputs.GHCR_VERSION_TAG }}
            ${{ steps.docker_tags.outputs.GHCR_LATEST_TAG }}
            ${{ steps.docker_tags.outputs.DOCKERHUB_VERSION_TAG }}
            ${{ steps.docker_tags.outputs.DOCKERHUB_LATEST_TAG }}
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BINARY_DIR=${{ inputs.binary-dir }}