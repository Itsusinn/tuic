name: Publish Release

on:
  workflow_call:
    inputs:
      cliff-config:
        description: 'Path to git-cliff config file'
        required: false
        type: string
        default: '.github/cliff.toml'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      #--------------------------------------------------
      # Setup Steps
      #--------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Download binary artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: "*-binaries"
          path: ./packages
          merge-multiple: true

      #--------------------------------------------------
      # Git Tag Management
      #--------------------------------------------------
      - name: Manage dev branch tags
        if: startsWith(github.ref, 'refs/heads/dev')
        run: |
          gh release delete latest --cleanup-tag --yes --repo $GITHUB_REPOSITORY || true
          # Move latest tag to current commit locally
          git tag -d latest || true
          # Create local tag
          git tag latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare versioned release tags
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Delete latest tag locally (for git-cliff)
          git tag -d latest || true

      #--------------------------------------------------
      # Changelog Generation
      #--------------------------------------------------
      - name: Generate changelog
        uses: orhun/git-cliff-action@main
        id: git-cliff
        with:
          config: ${{ inputs.cliff-config }}
          args: --latest --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}

      #--------------------------------------------------
      # Release Publishing
      #--------------------------------------------------
      - name: Publish stable release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          generate_release_notes: false
          body: ${{ steps.git-cliff.outputs.content }}
          files: |
            packages/*
            LICENSE

      - name: Publish nightly release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/heads/dev')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          generate_release_notes: false
          body: ${{ steps.git-cliff.outputs.content }}
          tag_name: "latest"
          files: |
            packages/*
            LICENSE